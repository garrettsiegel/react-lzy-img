name: Bundle Size Check

on:
  pull_request:
    branches: [main, master]

jobs:
  size:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: npm run build
      
      - name: Check bundle size
        run: |
          SIZE=$(du -k dist/index.es.js | cut -f1)
          GZIP_SIZE=$(gzip -c dist/index.es.js | wc -c | awk '{print int($1/1024)}')
          echo "üì¶ Bundle size: ${SIZE}KB"
          echo "üóúÔ∏è Gzipped size: ${GZIP_SIZE}KB"
          
          # Fail if gzipped size exceeds 2KB (2048 bytes)
          if [ $GZIP_SIZE -gt 2 ]; then
            echo "‚ùå Bundle size exceeded 2KB limit!"
            echo "Current: ${GZIP_SIZE}KB, Limit: 2KB"
            exit 1
          else
            echo "‚úÖ Bundle size is within 2KB limit"
          fi
      
      - name: Comment bundle size on PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const { execSync } = require('child_process');
            
            const size = execSync('du -k dist/index.es.js | cut -f1').toString().trim();
            const gzipSize = execSync('gzip -c dist/index.es.js | wc -c').toString().trim();
            const gzipKb = (parseInt(gzipSize) / 1024).toFixed(2);
            
            const comment = `## üì¶ Bundle Size Report
            
            - **Uncompressed**: ${size}KB
            - **Gzipped**: ${gzipKb}KB
            - **Limit**: 2KB
            - **Status**: ${parseFloat(gzipKb) <= 2 ? '‚úÖ Passed' : '‚ùå Exceeded'}`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
